(function(){"use strict";var t={2225:function(t,e,s){var i=s(9963),n=s(6252),o=s(3577);const r=t=>((0,n.dD)("data-v-7bf4c6b5"),t=t(),(0,n.Cn)(),t),l=r((()=>(0,n._)("header",null,[(0,n._)("h2",null,"特性検索（typeC）")],-1))),a={class:"controls-row"},c={class:"search-with-suggest"},u={key:0,class:"suggest-list",role:"listbox"},h=["onMousedown"],d={key:0,class:"transient-msg"},p={class:"layout"},g={class:"collapsed-column"},f={class:"collapsed-controls"},m=["onClick"],y={class:"collapsed-meta"},w={class:"collapsed-trait"},k={class:"small muted"},v=["onClick"],b={class:"main-column",ref:"mainColumn"},q={class:"blocks"},T={class:"block-head"},_={class:"trait-pill"},C=r((()=>(0,n._)("span",{class:"trait-accent","aria-hidden":"true"},null,-1))),D={class:"small muted"},S={key:0,class:"small muted"},I={class:"controls"},F=["onClick"],A=["onClick"],M={class:"cards"},x=["draggable","onDragstart"],$={class:"card-top"},L={class:"meta-top"},R={class:"name"},B={key:0,class:"freq-badge"},O={class:"card-actions"},z=["onClick"],j={key:1,class:"inuse"},V={class:"meta-bottom"},E={class:"match-list"},K={class:"match-trigger"},U={key:0},N={key:1},H={key:2},Y={key:1},J={class:"match-meta small muted"},P={class:"match-target"},Z={class:"match-others"},G={key:0},Q={key:1},W={key:2},X={key:0,class:"small muted"},tt=["title"],et={key:0,class:"freq-dot"},st={key:0,class:"block"},it=r((()=>(0,n._)("div",{class:"small muted"},"ここに検索ブロックが追加されます。特性を入力して検索してください。",-1))),nt=[it],ot={class:"formation"},rt=r((()=>(0,n._)("div",{class:"formation-head"},[(0,n._)("strong",null,"編成 (前列3 / 後列3)")],-1))),lt=r((()=>(0,n._)("div",{class:"small muted"},"各編成は個別に編集できます。編成の編集はドラッグ操作で行ってください。",-1))),at={class:"formations-grid"},ct={class:"formation-title"},ut={class:"slots"},ht=["draggable","onDragstart","onDragenter","onDragover","onDragleave","onDrop"],dt={key:0,class:"slot-occupied"},pt=["onDblclick"],gt={key:1,class:"slot-empty"},ft={class:"formation-actions"},mt=["onClick"],yt=["onClick"],wt={key:0,class:"save-dialog"},kt={class:"save-dialog-inner"},vt=r((()=>(0,n._)("label",null,"メモ（任意）",-1))),bt={class:"save-dialog-actions"},qt=["onClick"],Tt={class:"equip-section"},_t={class:"equip-row-list"},Ct={class:"equip-unit"},Dt={class:"equip-slots-row"},St=["onDrop"],It=["onDragstart","onDblclick"],Ft={key:1,class:"thumb tiny empty"};function At(t,e,s,r,it,At){return(0,n.wg)(),(0,n.iD)("div",{class:(0,o.C_)(["container",{"compact-mode":it.compactView}])},[l,(0,n._)("div",a,[(0,n._)("div",c,[(0,n.wy)((0,n._)("input",{ref:"searchInput",type:"text","onUpdate:modelValue":e[0]||(e[0]=t=>it.term=t),placeholder:"特性名を入力",onInput:e[1]||(e[1]=(...t)=>At.onTermInput&&At.onTermInput(...t)),onKeydown:e[2]||(e[2]=(...t)=>At.onTermKeydown&&At.onTermKeydown(...t)),onFocus:e[3]||(e[3]=t=>it.showSuggestions=!0),onBlur:e[4]||(e[4]=(...t)=>At.onTermBlur&&At.onTermBlur(...t))},null,544),[[i.nr,it.term]]),(0,n._)("button",{onClick:e[5]||(e[5]=(...t)=>At.searchTrait&&At.searchTrait(...t))},"検索"),it.showSuggestions&&At.suggestionList.length?((0,n.wg)(),(0,n.iD)("ul",u,[((0,n.wg)(!0),(0,n.iD)(n.HY,null,(0,n.Ko)(At.suggestionList,((t,e)=>((0,n.wg)(),(0,n.iD)("li",{key:t,class:(0,o.C_)({highlight:e===it.suggestionIndex}),onMousedown:(0,i.iM)((e=>At.selectSuggestion(t)),["prevent"]),role:"option"},(0,o.zw)(t),43,h)))),128))])):(0,n.kq)("",!0)]),(0,n._)("button",{class:"ghost",onClick:e[6]||(e[6]=t=>it.compactView=!it.compactView)},(0,o.zw)(it.compactView?"詳細表示":"簡易表示"),1),(0,n._)("button",{class:"ghost",onClick:e[7]||(e[7]=(...t)=>At.toggleFreq&&At.toggleFreq(...t))},(0,o.zw)(it.showFreq?"頻度表示: ON":"頻度表示: OFF"),1)]),it.transientMessage?((0,n.wg)(),(0,n.iD)("div",d,(0,o.zw)(it.transientMessage),1)):(0,n.kq)("",!0),(0,n._)("div",p,[(0,n._)("div",g,[(0,n._)("div",f,[(0,n._)("button",{class:"ghost",onClick:e[8]||(e[8]=(...t)=>At.collapseAllVisible&&At.collapseAllVisible(...t))},"まとめて縮小")]),((0,n.wg)(!0),(0,n.iD)(n.HY,null,(0,n.Ko)(it.blocks.filter((t=>t.collapsed)),(t=>((0,n.wg)(),(0,n.iD)("div",{key:"c-"+t.id,class:"collapsed-item",onClick:e=>At.expandBlockById(t.id)},[(0,n._)("div",{class:(0,o.C_)(["thumb small",t.results[0]&&t.results[0].image||""]),"aria-hidden":"true"},null,2),(0,n._)("div",y,[(0,n._)("div",w,(0,o.zw)(t.trait),1),(0,n._)("div",k,(0,o.zw)("number"===typeof t.count?t.count:t.fullResults&&t.fullResults.length||t.results.length)+" 件",1)]),(0,n._)("button",{class:"collapsed-close",onClick:(0,i.iM)((e=>At.removeBlock(t.id)),["stop"]),"aria-label":"閉じる"},"✕",8,v)],8,m)))),128))]),(0,n._)("div",b,[(0,n._)("div",q,[((0,n.wg)(!0),(0,n.iD)(n.HY,null,(0,n.Ko)(it.blocks.filter((t=>!t.collapsed)),(t=>((0,n.wg)(),(0,n.iD)("div",{class:"block",key:t.id},[(0,n._)("div",T,[(0,n._)("h3",null,[(0,n._)("span",_,[C,(0,n.Uk)(" 検索: 「"+(0,o.zw)(t.trait)+"」",1)]),(0,n._)("span",D,"("+(0,o.zw)("number"===typeof t.count?t.count:t.fullResults&&t.fullResults.length||t.results.length)+"件)",1),t.collapsed?((0,n.wg)(),(0,n.iD)("span",S," - 縮小中")):(0,n.kq)("",!0)]),(0,n._)("div",I,[(0,n._)("button",{class:"ghost",onClick:e=>At.toggleCollapse(t.id)},(0,o.zw)(t.collapsed?"展開":"縮小"),9,F),(0,n._)("button",{class:"ghost",onClick:e=>At.removeBlock(t.id)},"閉じる",8,A)])]),(0,n.wy)((0,n._)("div",M,[((0,n.wg)(!0),(0,n.iD)(n.HY,null,(0,n.Ko)(t.results,(t=>((0,n.wg)(),(0,n.iD)("div",{key:t.type+"-"+t.id,draggable:"unit"===t.type||"equip"===t.type,onDragstart:e=>At.onDragStartCard(e,t)},[it.compactView?((0,n.wg)(),(0,n.iD)("div",{key:1,class:(0,o.C_)(["card","compact",At.getFreqClass(t),{"in-use-compact":At.isInFormation(t)}]),title:t.name},[(0,n._)("div",{class:(0,o.C_)(["thumb small",t.image]),"aria-hidden":"true"},null,2),it.showFreq&&it.appearanceCounts[t.id]&&"unit"===t.type?((0,n.wg)(),(0,n.iD)("span",et,(0,o.zw)(it.appearanceCounts[t.id]),1)):(0,n.kq)("",!0)],10,tt)):((0,n.wg)(),(0,n.iD)("div",{key:0,class:(0,o.C_)(["card",At.getFreqClass(t)])},[(0,n._)("div",$,[(0,n._)("div",{class:(0,o.C_)(["thumb",t.image]),"aria-hidden":"true"},null,2),(0,n._)("div",L,[(0,n._)("h4",R,[(0,n.Uk)((0,o.zw)(t.name)+" ",1),it.showFreq&&it.appearanceCounts[t.id]&&"unit"===t.type?((0,n.wg)(),(0,n.iD)("span",B,(0,o.zw)(it.appearanceCounts[t.id])+"x",1)):(0,n.kq)("",!0)]),(0,n._)("div",O,["unit"===t.type?((0,n.wg)(),(0,n.iD)("button",{key:0,onClick:e=>At.toggleInFormation(t)},(0,o.zw)(At.isInFormation(t)?"編成から外す":"編成へ追加"),9,z)):(0,n.kq)("",!0),At.isInFormation(t)?((0,n.wg)(),(0,n.iD)("div",j,"使用中")):(0,n.kq)("",!0)])])]),(0,n._)("div",V,[(0,n._)("ul",E,[((0,n.wg)(!0),(0,n.iD)(n.HY,null,(0,n.Ko)(t.matches||[],(t=>((0,n.wg)(),(0,n.iD)("li",{key:t.id+"-"+t.trigger},[(0,n._)("div",K,[t.trigger1&&t.trigger2?((0,n.wg)(),(0,n.iD)(n.HY,{key:0},["and"===t.andor?((0,n.wg)(),(0,n.iD)("span",U,"発動: "+(0,o.zw)(t.trigger1)+" かつ "+(0,o.zw)(t.trigger2),1)):"or"===t.andor?((0,n.wg)(),(0,n.iD)("span",N,"発動: "+(0,o.zw)(t.trigger1)+" または "+(0,o.zw)(t.trigger2),1)):((0,n.wg)(),(0,n.iD)("span",H,"発動: "+(0,o.zw)(t.trigger1)+" / "+(0,o.zw)(t.trigger2),1))],64)):((0,n.wg)(),(0,n.iD)("span",Y,"発動: "+(0,o.zw)(t.trigger1||t.trigger2||t.trigger),1))]),(0,n._)("div",J,[(0,n._)("div",P,"対象: "+(0,o.zw)(Array.isArray(t.target)?t.target.join("、"):t.target),1),(0,n._)("div",Z,[t.effect?((0,n.wg)(),(0,n.iD)("span",G,"効果量: "+(0,o.zw)(t.effect),1)):(0,n.kq)("",!0),t.duration?((0,n.wg)(),(0,n.iD)("span",Q," 持続: "+(0,o.zw)(t.duration),1)):(0,n.kq)("",!0),t.cumulative?((0,n.wg)(),(0,n.iD)("span",W," 累積: "+(0,o.zw)(t.cumulative),1)):(0,n.kq)("",!0)])])])))),128)),0===(t.matches||[]).length?((0,n.wg)(),(0,n.iD)("li",X,"該当する特性データがありません")):(0,n.kq)("",!0)])])],2))],40,x)))),128))],512),[[i.F8,!t.collapsed]])])))),128)),0===it.blocks.length?((0,n.wg)(),(0,n.iD)("div",st,nt)):(0,n.kq)("",!0)])],512),(0,n._)("aside",null,[(0,n._)("div",ot,[rt,lt,(0,n._)("div",at,[((0,n.wg)(!0),(0,n.iD)(n.HY,null,(0,n.Ko)(it.formations,((t,s)=>((0,n.wg)(),(0,n.iD)("div",{class:"formation-box",key:s},[(0,n._)("div",ct,"編成 "+(0,o.zw)(s+1),1),(0,n._)("div",ut,[((0,n.wg)(!0),(0,n.iD)(n.HY,null,(0,n.Ko)(t,((t,e)=>((0,n.wg)(),(0,n.iD)("div",{key:s+"-"+e,class:(0,o.C_)(["slot",{"drag-over":it.dropTarget&&it.dropTarget.form===s&&it.dropTarget.index===e}]),draggable:!!t,onDragstart:i=>t&&At.onDragStartSlot(i,s,e),onDragenter:(0,i.iM)((t=>At.onDragEnterSlot(s,e)),["prevent"]),onDragover:(0,i.iM)((t=>At.onDragOverSlot(t,s,e)),["prevent"]),onDragleave:t=>At.onDragLeaveSlot(s,e),onDrop:(0,i.iM)((t=>At.onDropToSlot(t,s,e)),["prevent"])},[t?((0,n.wg)(),(0,n.iD)("div",dt,[(0,n._)("div",{class:(0,o.C_)(["thumb small",t.image]),"aria-hidden":"true",onDblclick:(0,i.iM)((t=>At.onSlotDoubleClick(s,e)),["stop","prevent"])},null,42,pt)])):((0,n.wg)(),(0,n.iD)("div",gt))],42,ht)))),128))]),(0,n._)("div",ft,[(0,n._)("button",{class:"ghost",onClick:t=>At.clearFormation(s)},"全解除",8,mt),(0,n._)("button",{class:"ghost",onClick:t=>At.openSaveFormationDialog(s)},"ライブラリへ保存",8,yt)]),it.savingForFormation===s?((0,n.wg)(),(0,n.iD)("div",wt,[(0,n._)("div",kt,[vt,(0,n.wy)((0,n._)("textarea",{"onUpdate:modelValue":e[9]||(e[9]=t=>it.savingMemo=t),rows:"4",placeholder:"編成の説明を入力してください"},null,512),[[i.nr,it.savingMemo]]),(0,n._)("div",bt,[(0,n._)("button",{class:"ghost",onClick:t=>At.doSaveFormationToLib(s)},"保存",8,qt),(0,n._)("button",{class:"ghost",onClick:e[10]||(e[10]=(...t)=>At.cancelSaveFormationDialog&&At.cancelSaveFormationDialog(...t))},"キャンセル")])])])):(0,n.kq)("",!0),(0,n._)("div",Tt,[(0,n._)("div",_t,[((0,n.wg)(!0),(0,n.iD)(n.HY,null,(0,n.Ko)(t,((t,r)=>((0,n.wg)(),(0,n.iD)(n.HY,null,[t?((0,n.wg)(),(0,n.iD)("div",{class:"equip-row-item",key:s+"-er-"+r},[(0,n._)("div",Ct,[(0,n._)("div",{class:(0,o.C_)(["thumb tiny",t&&t.image||""]),"aria-hidden":"true"},null,2)]),(0,n._)("div",Dt,[((0,n.wg)(!0),(0,n.iD)(n.HY,null,(0,n.Ko)(At.getMaxEquip(t),(t=>((0,n.wg)(),(0,n.iD)("div",{class:"equip-slot",key:t,onDragover:e[11]||(e[11]=(0,i.iM)((()=>{}),["prevent"])),onDrop:(0,i.iM)((e=>At.onDropToEquipSlot(e,s,r,t-1)),["prevent"])},[it.equipmentAssignments[s+"-"+r]&&it.equipmentAssignments[s+"-"+r][t-1]?((0,n.wg)(),(0,n.iD)("div",{key:0,class:(0,o.C_)(["thumb tiny",it.equipmentAssignments[s+"-"+r][t-1].equip.image||""]),draggable:"true",onDragstart:e=>At.onDragStartInstance(e,it.equipmentAssignments[s+"-"+r][t-1].id),onDblclick:(0,i.iM)((e=>At.onEquipInstanceDoubleClick(s,r,t-1)),["stop","prevent"])},null,42,It)):((0,n.wg)(),(0,n.iD)("div",Ft,"+"))],40,St)))),128))])])):(0,n.kq)("",!0)],64)))),256))])])])))),128))])])])])],2)}var Mt=s(7349),xt={name:"TraitSearch",data(){return{compactView:!1,term:"",suggestionIndex:-1,showSuggestions:!1,transientMessage:"",transientTimer:null,blocks:[],nextBlockId:1,units:[],equips:[],equipmentAssignments:{},equipInstanceCounter:1,instanceAssignmentMap:{},unitTokuseiList:[],soubiTokuseiList:[],formations:[[null,null,null,null,null,null],[null,null,null,null,null,null],[null,null,null,null,null,null]],currentFormation:0,savingForFormation:null,savingMemo:"",dropTarget:null,placedMap:{},appearanceCounts:{},showFreq:!0}},async mounted(){this.$nextTick((()=>{const t=this.$refs.searchInput;t&&"function"===typeof t.focus&&t.focus()}));try{const t=Mt.quickLoad();this.applyData(t),Mt.load().then((t=>{t&&this.applyData(t)})).catch((t=>{console.warn("storage.load() failed",t)}))}catch(t){console.error("データ読み込みエラー",t)}},methods:{applyData(t){if(!t)return;const{unitList:e=[],unitTokuseiList:s=[],soubiList:i=[],soubiTokuseiList:n=[]}=t;this.unitTokuseiList=s,this.soubiTokuseiList=n;const o={};for(const a of s){const t=a.unit_no;o[t]||(o[t]=[]),a["特性"]&&o[t].push(a["特性"])}const r={};for(const a of n){const t=a.soubi_no;r[t]||(r[t]=[]),a["特性"]&&r[t].push(a["特性"])}this.units=(e||[]).slice().reverse().map((t=>({id:"u"+t.no,type:"unit",no:t.no,name:t.name,rarity:t.rarity||3,attribute:t.type||"",hp:t.hp,attack:t.power,traits:o[t.no]||[],image:t.image||"",equips:[]}))),this.equips=(i||[]).slice().reverse().map((t=>({id:"e"+t.no,type:"equip",no:t.no,name:t.name,rarity:t.rarity||3,hp:t.hp,power:t.power,traits:r[t.no]||[],image:t.image||""})));try{this.reevaluateSavedSearches()}catch(l){}},onTermInput(){this.showSuggestions=!(!this.term||!String(this.term).trim()),this.suggestionIndex=-1},onTermKeydown(t){if(!this.showSuggestions)return;const e=this.suggestionList.length;if("ArrowDown"===t.key){if(t.preventDefault(),0===e)return;this.suggestionIndex=(this.suggestionIndex+1)%e,this.scrollSuggestionIntoView()}else if("ArrowUp"===t.key){if(t.preventDefault(),0===e)return;this.suggestionIndex=(this.suggestionIndex-1+e)%e,this.scrollSuggestionIntoView()}else if("Enter"===t.key){if(this.suggestionIndex>=0&&this.suggestionIndex<e){t.preventDefault();const e=this.suggestionList[this.suggestionIndex];this.selectSuggestion(e)}}else"Escape"===t.key&&(this.showSuggestions=!1)},onTermBlur(t){setTimeout((()=>{this.showSuggestions=!1,this.suggestionIndex=-1}),120)},selectSuggestion(t){this.term=t,this.showSuggestions=!1,this.suggestionIndex=-1,this.$nextTick((()=>{const t=this.$refs.searchInput;t&&"function"===typeof t.focus&&t.focus()}))},scrollSuggestionIntoView(){try{const t=this.$el&&this.$el.querySelector&&this.$el.querySelector(".suggest-list");if(!t)return;const e=t.children[this.suggestionIndex];e&&"function"===typeof e.scrollIntoView&&e.scrollIntoView({block:"nearest"})}catch(t){}},computeResultsForTrait(t){const e=(t||"").trim().toLowerCase();if(!e)return[];const s=[];for(const i of this.units){const t=(this.unitTokuseiList||[]).filter((t=>t.unit_no===i.no&&t["特性"]&&t["特性"].trim().toLowerCase()===e));t.length&&s.push(Object.assign({},i,{matches:t.map((t=>({id:t.id||`${i.no}-u-${Math.random()}`,trigger1:t.trigger1||"",trigger2:t.trigger2||"",andor:String(t.andor||"").toLowerCase(),trigger:[t.trigger1,t.trigger2].filter(Boolean).join(" / "),target:Array.isArray(t["対象"])?t["対象"]:t["対象"]||"",effect:t["効果量"]||"",duration:t["持続"]||"",cumulative:t["累積"]||""})))}))}for(const i of this.equips){const t=(this.soubiTokuseiList||[]).filter((t=>t.soubi_no===i.no&&t["特性"]&&t["特性"].trim().toLowerCase()===e));t.length&&s.push(Object.assign({},i,{matches:t.map((t=>({id:t.id||`${i.no}-s-${Math.random()}`,trigger1:t.trigger1||"",trigger2:t.trigger2||"",andor:String(t.andor||"").toLowerCase(),trigger:[t.trigger1,t.trigger2].filter(Boolean).join(" / "),target:Array.isArray(t["対象"])?t["対象"]:t["対象"]||"",effect:t["効果量"]||"",duration:t["持続"]||"",cumulative:t["累積"]||""})))}))}return s},computeCountForTrait(t){const e=(t||"").trim().toLowerCase();if(!e)return 0;const s=new Set,i=new Set;for(const n of this.unitTokuseiList||[])n["特性"]&&String(n["特性"]).trim().toLowerCase()===e&&s.add(n.unit_no);for(const n of this.soubiTokuseiList||[])n["特性"]&&String(n["特性"]).trim().toLowerCase()===e&&i.add(n.soubi_no);return s.size+i.size},_collectAllTraits(){const t=new Set;for(const e of this.unitTokuseiList||[])e["特性"]&&t.add(String(e["特性"]).trim());for(const e of this.soubiTokuseiList||[])e["特性"]&&t.add(String(e["特性"]).trim());return Array.from(t)},reevaluateSavedSearches(){let t=null;try{t=Mt.traitSearchData("state.v1")}catch(e){t=null}if(t){if("boolean"===typeof t.compactView&&(this.compactView=t.compactView),"boolean"===typeof t.showFreq&&(this.showFreq=t.showFreq),Array.isArray(t.formations)){this.formations=this.formations.map((t=>t.map((()=>null))));for(let e=0;e<t.formations.length&&e<this.formations.length;e++){const s=t.formations[e];if(Array.isArray(s))for(let t=0;t<s.length&&t<this.formations[e].length;t++){const i=s[t];if(!i){this.formations[e][t]=null;continue}const n=(this.units||[]).find((t=>t.id===i))||null;n&&(this.formations[e][t]=n,this.placedMap[n.id]={f:e,i:t})}}}if(t.equipment&&"object"===typeof t.equipment){this.equipmentAssignments={},this.instanceAssignmentMap={};for(const e of Object.keys(t.equipment)){const s=Array.isArray(t.equipment[e])?t.equipment[e]:[];if(s&&s.length){this.equipmentAssignments[e]=[];for(const t of s){const s=(this.equips||[]).find((e=>e.id===t))||null;if(!s)continue;const i=this.makeEquipInstance(s);this.equipmentAssignments[e].push(i),this.instanceAssignmentMap[i.id]=e}}}}if(Array.isArray(t.traits)&&t.traits.length){this.blocks=[];for(const e of t.traits){const t=this.computeCountForTrait(e);if(!t||0===t)continue;const s={id:this.nextBlockId++,trait:e,fullResults:null,results:[],count:t,collapsed:!0,_fillTimer:null,_chunkIdx:0};this.blocks.push(s)}}}},saveState(){const t={compactView:!!this.compactView,showFreq:!!this.showFreq,traits:(this.blocks||[]).map((t=>t.trait)),formations:(this.formations||[]).map((t=>t.map((t=>t&&t.id?t.id:null)))),equipment:{}};for(const s of Object.keys(this.equipmentAssignments||{})){const e=this.equipmentAssignments[s]||[];t.equipment[s]=e.map((t=>t&&t.equip&&t.equip.id?t.equip.id:null)).filter(Boolean)}try{Mt.traitSearchData("state.v1",t)}catch(e){}},scheduleFillForBlock(t){if(!t)return;const e=60,s=80;t.results||(t.results=[]);try{if(t._fillTimer)return}catch(n){}const i=()=>{try{if(!t.fullResults){try{t.fullResults=this.computeResultsForTrait(t.trait)}catch(n){t.fullResults=[]}try{this.applyCountsForBlock(t,!0)}catch(n){}try{t.count=t.fullResults.length}catch(n){}if(!t.fullResults||0===t.fullResults.length){const e=this.blocks.findIndex((e=>e.id===t.id));-1!==e&&this.blocks.splice(e,1);try{this.removeCountsForBlock(t)}catch(n){}try{this.saveState()}catch(n){}return void(t._fillTimer=null)}t.results=t.fullResults.slice(0,Math.min(s,t.fullResults.length))}const o=t.fullResults.length,r=t.results.length;if(r>=o)return void(t._fillTimer=null);const l=r,a=Math.min(o,l+e);t.results.push(...t.fullResults.slice(l,a)),a<o?"undefined"!==typeof window&&"function"===typeof window.requestIdleCallback?t._fillTimer=window.requestIdleCallback((()=>i()),{timeout:200}):t._fillTimer=setTimeout((()=>i()),40):t._fillTimer=null}catch(n){t._fillTimer=null}};"undefined"!==typeof window&&"function"===typeof window.requestIdleCallback?t._fillTimer=window.requestIdleCallback((()=>i()),{timeout:200}):t._fillTimer=setTimeout((()=>i()),40)},searchTrait(){const t=(this.term||"").trim();if(!t)return alert("特性名を入力してください"),void this.$nextTick((()=>{const t=this.$refs.searchInput;t&&"function"===typeof t.focus&&t.focus()}));const e=t.toLowerCase(),s=(this.blocks||[]).findIndex((t=>(t.trait||"").trim().toLowerCase()===e));if(-1!==s){const t=this.blocks[s];t.collapsed=!1,this.blocks.splice(s,1),this.blocks.unshift(t);const e=80,i=60;t.fullResults&&t.results&&t.results.length<Math.min(e,t.fullResults.length)&&(t.results=t.fullResults.slice(0,Math.min(e,t.fullResults.length)));try{t.fullResults&&(t.count=t.fullResults.length)}catch(c){}try{this.applyCountsForBlock(t,!1)}catch(c){}const n=()=>{if(!t.fullResults)return;const e=t.fullResults.length,s=t.results.length;if(s>=e)return;const o=s,r=Math.min(e,o+i);t.results.push(...t.fullResults.slice(o,r)),r<e&&("undefined"!==typeof window&&"function"===typeof window.requestIdleCallback?t._fillTimer=window.requestIdleCallback((()=>n()),{timeout:200}):t._fillTimer=setTimeout((()=>n()),40))};t.fullResults&&t.results.length<t.fullResults.length&&("undefined"!==typeof window&&"function"===typeof window.requestIdleCallback?t._fillTimer=window.requestIdleCallback((()=>n()),{timeout:200}):t._fillTimer=setTimeout((()=>n()),40));try{t.fullResults||this.scheduleFillForBlock(t)}catch(c){}this.$nextTick((()=>{const t=this.$refs.mainColumn;t&&"undefined"!==typeof t.scrollTop&&(t.scrollTop=0);const e=this.$refs.searchInput;e&&"function"===typeof e.focus&&e.focus()}));try{this.saveState()}catch(c){}return void(this.term="")}const i=[];for(const u of this.units){const t=(this.unitTokuseiList||[]).filter((t=>t.unit_no===u.no&&t["特性"]&&t["特性"].trim().toLowerCase()===e));if(t.length){const e=t.map((t=>({id:t.id||`${u.no}-u-${Math.random()}`,trigger1:t.trigger1||"",trigger2:t.trigger2||"",andor:String(t.andor||"").toLowerCase(),trigger:[t.trigger1,t.trigger2].filter(Boolean).join(" / "),target:Array.isArray(t["対象"])?t["対象"]:t["対象"]||"",effect:t["効果量"]||"",duration:t["持続"]||"",cumulative:t["累積"]||""})));i.push(Object.assign({},u,{matches:e}))}}for(const u of this.equips){const t=(this.soubiTokuseiList||[]).filter((t=>t.soubi_no===u.no&&t["特性"]&&t["特性"].trim().toLowerCase()===e));if(t.length){const e=t.map((t=>({id:t.id||`${u.no}-s-${Math.random()}`,trigger1:t.trigger1||"",trigger2:t.trigger2||"",andor:String(t.andor||"").toLowerCase(),trigger:[t.trigger1,t.trigger2].filter(Boolean).join(" / "),target:Array.isArray(t["対象"])?t["対象"]:t["対象"]||"",effect:t["効果量"]||"",duration:t["持続"]||"",cumulative:t["累積"]||""})));i.push(Object.assign({},u,{matches:e}))}}if(!i||0===i.length)return this.term="",this.showTransient("該当する特性はありません"),void this.$nextTick((()=>{const t=this.$refs.searchInput;t&&"function"===typeof t.focus&&t.focus()}));const n=80,o=60,r=i,l={id:this.nextBlockId++,trait:t,fullResults:r,results:r.slice(0,n),count:r.length,collapsed:!1,_fillTimer:null,_chunkIdx:1};try{this.applyCountsForBlock(l,!1)}catch(c){}this.blocks.unshift(l);try{this.saveState()}catch(c){}const a=()=>{if(!l.fullResults)return;const t=l.fullResults.length,e=l.results.length;if(e>=t)return;const s=e,i=Math.min(t,s+o);l.results.push(...l.fullResults.slice(s,i)),i<t&&("undefined"!==typeof window&&"function"===typeof window.requestIdleCallback?l._fillTimer=window.requestIdleCallback((()=>a()),{timeout:200}):l._fillTimer=setTimeout((()=>a()),40))};r.length>l.results.length&&("undefined"!==typeof window&&"function"===typeof window.requestIdleCallback?l._fillTimer=window.requestIdleCallback((()=>a()),{timeout:200}):l._fillTimer=setTimeout((()=>a()),40)),this.term="",this.$nextTick((()=>{const t=this.$refs.mainColumn;t&&"undefined"!==typeof t.scrollTop&&(t.scrollTop=0);const e=this.$refs.searchInput;e&&"function"===typeof e.focus&&e.focus()}))},removeBlock(t){const e=this.blocks.findIndex((e=>e.id===t));if(-1===e)return;const s=this.blocks[e];try{this.removeCountsForBlock(s)}catch(i){}try{s&&s._fillTimer&&("undefined"!==typeof window&&"function"===typeof window.cancelIdleCallback?window.cancelIdleCallback(s._fillTimer):clearTimeout(s._fillTimer))}catch(i){}this.blocks.splice(e,1);try{this.saveState()}catch(i){}},toggleCollapse(t){const e=this.blocks.findIndex((e=>e.id===t));if(-1===e)return;const s=this.blocks[e];s.collapsed=!s.collapsed;try{s.collapsed?this.removeCountsForBlock(s):this.applyCountsForBlock(s,!1)}catch(i){}if(this.blocks.splice(e,1),this.blocks.unshift(s),!s.collapsed){this.$nextTick((()=>{const t=this.$refs.mainColumn;t&&"undefined"!==typeof t.scrollTop&&(t.scrollTop=0)}));try{this.scheduleFillForBlock(s)}catch(i){}}},expandBlockById(t){const e=this.blocks.findIndex((e=>e.id===t));if(-1===e)return;const s=this.blocks[e];if(s.collapsed){s.collapsed=!1;try{this.applyCountsForBlock(s,!1)}catch(i){}this.blocks.splice(e,1),this.blocks.unshift(s),this.$nextTick((()=>{const t=this.$refs.mainColumn;t&&"undefined"!==typeof t.scrollTop&&(t.scrollTop=0);try{this.scheduleFillForBlock(s)}catch(i){}}))}},collapseAllVisible(){for(const t of this.blocks)t.collapsed=!0;this.$nextTick((()=>{const t=this.$refs.mainColumn;t&&"undefined"!==typeof t.scrollTop&&(t.scrollTop=0)}))},onDragStartCard(t,e){!e||"unit"!==e.type&&"equip"!==e.type||t.dataTransfer.setData("text/plain",JSON.stringify({source:"search",id:e.id,type:e.type}))},onDragStartInstance(t,e){if(!e)return;let s=null;try{const t=this.instanceAssignmentMap[e];if(t&&this.equipmentAssignments[t]){const i=this.equipmentAssignments[t].find((t=>t&&t.id===e));i&&i.equip&&i.equip.id&&(s=i.equip.id)}}catch(t){}t.dataTransfer.setData("text/plain",JSON.stringify({source:"instance",id:e,type:"equip",equipId:s}))},onDragStartSlot(t,e,s){const i=this.formations[e],n=i[s];n&&t.dataTransfer.setData("text/plain",JSON.stringify({source:"formation",id:n.id,fromFormation:e,fromIndex:s}))},onDragEnterSlot(t,e){this.dropTarget={form:t,index:e}},onDragOverSlot(t,e,s){t.preventDefault(),this.dropTarget={form:e,index:s}},onDragLeaveSlot(t,e){this.dropTarget&&this.dropTarget.form===t&&this.dropTarget.index===e&&(this.dropTarget=null)},onDropToSlot(t,e,s){this.dropTarget=null;let i=null;try{i=JSON.parse(t.dataTransfer.getData("text/plain"))}catch(n){return}if(i){if("formation"===i.source){const n=Number(i.fromFormation),o=Number(i.fromIndex);if(isNaN(o)||isNaN(n))return;const r=this.formations[n],l=this.formations[e],a=r[o],c=l[s];l[s]=a,r[o]=c;try{const t=`${n}-${o}`,i=`${e}-${s}`,r=this.equipmentAssignments[t];this.equipmentAssignments[t]=this.equipmentAssignments[i],this.equipmentAssignments[i]=r;const l=this.equipmentAssignments[t]||[],a=this.equipmentAssignments[i]||[];for(const e of l)e&&e.id&&(this.instanceAssignmentMap[e.id]=t);for(const e of a)e&&e.id&&(this.instanceAssignmentMap[e.id]=i)}catch(t){}try{this.saveState()}catch(t){}return l[s]&&(this.placedMap[l[s].id]={f:e,i:s}),r[o]&&(this.placedMap[r[o].id]={f:n,i:o}),c&&delete this.placedMap[c.id],void(!a||l[s]&&l[s].id===a.id||(this.placedMap[a.id]={f:e,i:s}))}if("search"===i.source){const n=this.formations[e];if(n[s])return void this.showTransient("スロットが埋まっています。入れ替えは編成内のユニットをドラッグしてください",3e3);const o=i.id,r=(this.units||[]).find((t=>t.id===o));if(!r)return void this.showTransient("ユニットが見つかりません",2e3);const l=this.placedMap[r.id];l&&"number"===typeof l.f&&"number"===typeof l.i&&(this.formations[l.f][l.i]=null,delete this.placedMap[r.id]);const a=n[s];a&&delete this.placedMap[a.id],n[s]=r,this.placedMap[r.id]={f:e,i:s};try{this.saveState()}catch(t){}if("equip"===i.type){const n=i.id,o=(this.equips||[]).find((t=>t.id===n));if(!o)return void this.showTransient("装備が見つかりません",2e3);const r=`${e}-${s}`;this.equipmentAssignments[r]||(this.equipmentAssignments[r]=[]);const l=this.formations[e][s],a=this.getMaxEquip(l);if(this.equipmentAssignments[r].length>=a)return void this.showTransient("装備上限に達しています",2e3);const c=this.makeEquipInstance(o);this.equipmentAssignments[r].push(c),this.instanceAssignmentMap[c.id]=r;try{this.saveState()}catch(t){}}}}},showTransient(t,e=3e3){this.transientTimer&&clearTimeout(this.transientTimer),this.transientMessage=t,this.transientTimer=setTimeout((()=>{this.transientMessage="",this.transientTimer=null}),e)},makeEquipInstance(t){const e="inst"+this.equipInstanceCounter++;return{id:e,equip:t}},onDropToEquipSlot(t,e,s,i){let n=null;try{n=JSON.parse(t.dataTransfer.getData("text/plain"))}catch(r){return}if(!n)return;const o=`${e}-${s}`;if(this.equipmentAssignments[o]||(this.equipmentAssignments[o]=[]),"instance"!==n.source||"equip"!==n.type){if("search"===n.source&&"equip"===n.type){const i=(this.equips||[]).find((t=>t.id===n.id));if(!i)return void this.showTransient("装備が見つかりません",2e3);const r=this.formations[e][s],l=this.getMaxEquip(r);if(this.equipmentAssignments[o].length>=l)return void this.showTransient("装備上限に達しています",2e3);const a=this.makeEquipInstance(i);this.equipmentAssignments[o].push(a),this.instanceAssignmentMap[a.id]=o;try{this.saveState()}catch(t){}}}else{const e=n.id,s=this.instanceAssignmentMap[e];if(s&&this.equipmentAssignments[s]){const t=this.equipmentAssignments[s],i=t.findIndex((t=>t&&t.id===e));-1!==i&&t.splice(i,1)}const i=(this.equips||[]).find((t=>t.id===n.equipId))||null;this.equipmentAssignments[o].push({id:e,equip:i}),this.instanceAssignmentMap[e]=o;try{this.saveState()}catch(t){}}},incrementCountsForResults(t){if(!t||!t.length)return;const e=[];for(const i of t)try{i&&"unit"===i.type&&e.push(i.id)}catch(s){}this.incrementCountsForIds(e)},decrementCountsForResults(t){if(!t||!t.length)return;const e=[];for(const i of t)try{i&&"unit"===i.type&&e.push(i.id)}catch(s){}this.decrementCountsForIds(e)},incrementCountsForIds(t){if(t&&t.length)for(const s of t)try{this.appearanceCounts[s]=(this.appearanceCounts[s]||0)+1}catch(e){}},decrementCountsForIds(t){if(t&&t.length)for(const s of t)try{const t=this.appearanceCounts[s]||0,i=t-1;if(i<=0)try{delete this.appearanceCounts[s]}catch(e){this.appearanceCounts[s]=0}else this.appearanceCounts[s]=i}catch(e){}},applyCountsForBlock(t,e=!1){if(!t)return;const s=e&&t.fullResults?t.fullResults:t.results||[];if(!s||!s.length)return;t._appliedUnitIds||(t._appliedUnitIds=Object.create(null));const i=[];for(const o of s)try{if(!o||"unit"!==o.type)continue;const e=o.id;t._appliedUnitIds[e]||(i.push(e),t._appliedUnitIds[e]=!0)}catch(n){}i.length&&this.incrementCountsForIds(i)},removeCountsForBlock(t){if(!t||!t._appliedUnitIds)return;const e=Object.keys(t._appliedUnitIds||{});e.length&&this.decrementCountsForIds(e);try{delete t._appliedUnitIds}catch(s){t._appliedUnitIds=null}},getFreqClass(t){if(!t||"unit"!==t.type)return"";if(!this.showFreq)return"";const e=this.appearanceCounts[t.id]||0;if(!e)return"";const s=this.maxAppearanceCount||1,i=e/s;return i>=.66?"freq-high":i>=.33?"freq-mid":"freq-low"},toggleFreq(){this.showFreq=!this.showFreq;try{this.saveState()}catch(t){}},toggleInFormation(t){if("unit"!==t.type)return void alert("ユニットのみ編成できます");const e=this.placedMap[t.id];if(e&&"number"===typeof e.f&&"number"===typeof e.i){this.formations[e.f][e.i]=null,delete this.placedMap[t.id];try{this.saveState()}catch(s){}}else{for(let e=0;e<this.formations.length;e++){const i=this.formations[e].findIndex((t=>!t));if(-1!==i){this.formations[e][i]=t,this.placedMap[t.id]={f:e,i:i};try{this.saveState()}catch(s){}return}}alert("空きスロットがありません")}},getMaxEquip(t){return t&&t.traits&&Array.isArray(t.traits)&&t.traits.includes("鏡スロット追加")?4:2},assignedCountFor(t,e){const s=`${t}-${e}`;return(this.equipmentAssignments[s]||[]).length},isInFormation(t){return!!(t&&t.id&&this.placedMap[t.id])},removeFromFormation(t,e){const s=this.formations[t][e];s&&s.id&&delete this.placedMap[s.id],this.formations[t][e]=null;try{this.saveState()}catch(i){}},onSlotDoubleClick(t,e){this.removeFromFormation(t,e)},onEquipInstanceDoubleClick(t,e,s){const i=`${t}-${e}`,n=this.equipmentAssignments[i]||[];if(s<0||s>=n.length)return;const o=n[s];if(o){n.splice(s,1);try{o.id&&delete this.instanceAssignmentMap[o.id]}catch(r){}0===n.length&&delete this.equipmentAssignments[i];try{this.saveState()}catch(r){}}},openSaveFormationDialog(t){this.savingForFormation=t;try{this.savingMemo=this.generateFormationMemo(t)}catch(e){this.savingMemo=""}this.$nextTick((()=>{const t=document.querySelector(".save-dialog textarea");t&&"function"===typeof t.focus&&t.focus()}))},cancelSaveFormationDialog(){this.savingForFormation=null,this.savingMemo=""},doSaveFormationToLib(t){try{const e=Mt.libData()||[],s={};for(let i=0;i<(this.formations[t]||[]).length;i++){const e=this.formations[t][i],n=(i+1).toString(),o={};o.unit_no=e&&e.no?e.no:null;const r=`${t}-${i}`,l=this.equipmentAssignments[r]||[],a=this.getMaxEquip(e)||2;for(let t=0;t<a&&t<4;t++){const e=`soubi${t+1}_no`;o[e]=l[t]&&l[t].equip&&"undefined"!==typeof l[t].equip.no?l[t].equip.no:null}"undefined"===typeof o.soubi1_no&&(o.soubi1_no=null),"undefined"===typeof o.soubi2_no&&(o.soubi2_no=null),s[n]=o}s.memo=this.savingMemo||"",e.push(s),Mt.libData(e),this.showTransient("編成をライブラリに保存しました",2500)}catch(e){console.error("doSaveFormationToLib failed",e),this.showTransient("保存に失敗しました",3e3)}finally{this.savingForFormation=null,this.savingMemo=""}},generateFormationMemo(t){const e=[],s=this.formations[t]||[];for(let i=0;i<s.length;i++){const n=i+1,o=s[i],r=o&&o.name?o.name:"（空）",l=`${t}-${i}`,a=this.equipmentAssignments[l]||[],c=this.getMaxEquip(o)||2,u=[];for(let t=0;t<c&&t<4;t++)u.push(a[t]&&a[t].equip&&a[t].equip.name?a[t].equip.name:"（空）");e.push(`${n}: ${r} — 装備: ${u.join(", ")}`)}return e.join("\n")},clearBlocks(){for(const e of this.blocks){try{e&&e._fillTimer&&("undefined"!==typeof window&&"function"===typeof window.cancelIdleCallback?window.cancelIdleCallback(e._fillTimer):clearTimeout(e._fillTimer))}catch(t){}try{this.removeCountsForBlock(e)}catch(t){}}try{this.saveState()}catch(t){}this.blocks=[]},clearFormation(t){for(let s=0;s<this.formations[t].length;s++){const i=this.formations[t][s];i&&i.id&&delete this.placedMap[i.id],this.formations[t][s]=null;const n=`${t}-${s}`,o=this.equipmentAssignments[n];if(o&&Array.isArray(o))for(const t of o)try{t&&t.id&&delete this.instanceAssignmentMap[t.id]}catch(e){}try{delete this.equipmentAssignments[n]}catch(e){}}try{this.saveState()}catch(e){}}},computed:{suggestionList(){const t=(this.term||"").trim().toLowerCase();if(!t)return[];const e=this._collectAllTraits(),s=[];for(const i of e)if(0===String(i).toLowerCase().indexOf(t)&&s.push(i),s.length>=10)break;return s.slice(0,10)},maxAppearanceCount(){let t=0;try{for(const e of Object.keys(this.appearanceCounts||{})){const s=this.appearanceCounts[e]||0;s>t&&(t=s)}}catch(e){t=0}return t}},watch:{compactView(t){try{this.saveState()}catch(e){}},showFreq(t){try{this.saveState()}catch(e){}}}},$t=s(3744);const Lt=(0,$t.Z)(xt,[["render",At],["__scopeId","data-v-7bf4c6b5"]]);var Rt=Lt;(0,i.ri)(Rt).mount("#main")}},e={};function s(i){var n=e[i];if(void 0!==n)return n.exports;var o=e[i]={exports:{}};return t[i].call(o.exports,o,o.exports,s),o.exports}s.m=t,function(){var t=[];s.O=function(e,i,n,o){if(!i){var r=1/0;for(u=0;u<t.length;u++){i=t[u][0],n=t[u][1],o=t[u][2];for(var l=!0,a=0;a<i.length;a++)(!1&o||r>=o)&&Object.keys(s.O).every((function(t){return s.O[t](i[a])}))?i.splice(a--,1):(l=!1,o<r&&(r=o));if(l){t.splice(u--,1);var c=n();void 0!==c&&(e=c)}}return e}o=o||0;for(var u=t.length;u>0&&t[u-1][2]>o;u--)t[u]=t[u-1];t[u]=[i,n,o]}}(),function(){s.d=function(t,e){for(var i in e)s.o(e,i)&&!s.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})}}(),function(){s.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"===typeof window)return window}}()}(),function(){s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)}}(),function(){s.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}}(),function(){s.j=777}(),function(){var t={777:0};s.O.j=function(e){return 0===t[e]};var e=function(e,i){var n,o,r=i[0],l=i[1],a=i[2],c=0;if(r.some((function(e){return 0!==t[e]}))){for(n in l)s.o(l,n)&&(s.m[n]=l[n]);if(a)var u=a(s)}for(e&&e(i);c<r.length;c++)o=r[c],s.o(t,o)&&t[o]&&t[o][0](),t[o]=0;return s.O(u)},i=self["webpackChunkfront"]=self["webpackChunkfront"]||[];i.forEach(e.bind(null,0)),i.push=e.bind(null,i.push.bind(i))}();var i=s.O(void 0,[998,64],(function(){return s(2225)}));i=s.O(i)})();
(function(){"use strict";var t={4168:function(t,i,e){var s=e(9963),n=e(6252),o=e(3577);const l=t=>((0,n.dD)("data-v-617ff240"),t=t(),(0,n.Cn)(),t),a=l((()=>(0,n._)("header",null,[(0,n._)("h2",null,"特性検索（typeC）")],-1))),r={class:"controls-row"},c={key:0,class:"transient-msg"},u={class:"layout"},d={class:"collapsed-column"},h={class:"collapsed-controls"},m=["onClick"],f={class:"collapsed-meta"},p={class:"collapsed-trait"},g={class:"small muted"},y=["onClick"],v={class:"main-column",ref:"mainColumn"},w={class:"blocks"},k={class:"block-head"},b={class:"trait-pill"},q=l((()=>(0,n._)("span",{class:"trait-accent","aria-hidden":"true"},null,-1))),T={class:"small muted"},_={key:0,class:"small muted"},D={class:"controls"},C=["onClick"],A=["onClick"],S={class:"cards"},M=["draggable","onDragstart"],I={key:0,class:"card"},F={class:"card-top"},x={class:"meta-top"},$={class:"name"},L={class:"card-actions"},R=["onClick"],O={key:1,class:"inuse"},j={class:"meta-bottom"},z={class:"match-list"},B={class:"match-trigger"},E={key:0},V={key:1},N={key:2},H={key:1},Y={class:"match-meta small muted"},K={class:"match-target"},J={class:"match-others"},P={key:0},U={key:1},Z={key:2},G={key:0,class:"small muted"},Q=["title"],W={key:0,class:"block"},X=l((()=>(0,n._)("div",{class:"small muted"},"ここに検索ブロックが追加されます。特性を入力して検索してください。",-1))),tt=[X],it={class:"formation"},et=l((()=>(0,n._)("div",{class:"formation-head"},[(0,n._)("strong",null,"編成 (前列3 / 後列3)")],-1))),st=l((()=>(0,n._)("div",{class:"small muted"},"各編成は個別に編集できます。編成の編集はドラッグ操作で行ってください。",-1))),nt={class:"formations-grid"},ot={class:"formation-title"},lt={class:"slots"},at=["draggable","onDragstart","onDragenter","onDragover","onDragleave","onDrop"],rt={key:0,class:"slot-occupied"},ct=["onDblclick"],ut={key:1,class:"slot-empty"},dt={class:"formation-actions"},ht=["onClick"],mt=["onClick"],ft={key:0,class:"save-dialog"},pt={class:"save-dialog-inner"},gt=l((()=>(0,n._)("label",null,"メモ（任意）",-1))),yt={class:"save-dialog-actions"},vt=["onClick"],wt={class:"equip-section"},kt={class:"equip-row-list"},bt={class:"equip-unit"},qt={class:"equip-slots-row"},Tt=["onDrop"],_t=["onDragstart","onDblclick"],Dt={key:1,class:"thumb tiny empty"};function Ct(t,i,e,l,X,Ct){return(0,n.wg)(),(0,n.iD)("div",{class:(0,o.C_)(["container",{"compact-mode":X.compactView}])},[a,(0,n._)("div",r,[(0,n.wy)((0,n._)("input",{ref:"searchInput",type:"text","onUpdate:modelValue":i[0]||(i[0]=t=>X.term=t),placeholder:"特性名を入力"},null,512),[[s.nr,X.term]]),(0,n._)("button",{onClick:i[1]||(i[1]=(...t)=>Ct.searchTrait&&Ct.searchTrait(...t))},"検索"),(0,n._)("button",{class:"ghost",onClick:i[2]||(i[2]=t=>X.compactView=!X.compactView)},(0,o.zw)(X.compactView?"詳細表示":"簡易表示"),1)]),X.transientMessage?((0,n.wg)(),(0,n.iD)("div",c,(0,o.zw)(X.transientMessage),1)):(0,n.kq)("",!0),(0,n._)("div",u,[(0,n._)("div",d,[(0,n._)("div",h,[(0,n._)("button",{class:"ghost",onClick:i[3]||(i[3]=(...t)=>Ct.collapseAllVisible&&Ct.collapseAllVisible(...t))},"まとめて縮小")]),((0,n.wg)(!0),(0,n.iD)(n.HY,null,(0,n.Ko)(X.blocks.filter((t=>t.collapsed)),(t=>((0,n.wg)(),(0,n.iD)("div",{key:"c-"+t.id,class:"collapsed-item",onClick:i=>Ct.expandBlockById(t.id)},[(0,n._)("div",{class:(0,o.C_)(["thumb small",t.results[0]&&t.results[0].image||""]),"aria-hidden":"true"},null,2),(0,n._)("div",f,[(0,n._)("div",p,(0,o.zw)(t.trait),1),(0,n._)("div",g,(0,o.zw)("number"===typeof t.count?t.count:t.fullResults&&t.fullResults.length||t.results.length)+" 件",1)]),(0,n._)("button",{class:"collapsed-close",onClick:(0,s.iM)((i=>Ct.removeBlock(t.id)),["stop"]),"aria-label":"閉じる"},"✕",8,y)],8,m)))),128))]),(0,n._)("div",v,[(0,n._)("div",w,[((0,n.wg)(!0),(0,n.iD)(n.HY,null,(0,n.Ko)(X.blocks.filter((t=>!t.collapsed)),(t=>((0,n.wg)(),(0,n.iD)("div",{class:"block",key:t.id},[(0,n._)("div",k,[(0,n._)("h3",null,[(0,n._)("span",b,[q,(0,n.Uk)(" 検索: 「"+(0,o.zw)(t.trait)+"」",1)]),(0,n._)("span",T,"("+(0,o.zw)("number"===typeof t.count?t.count:t.fullResults&&t.fullResults.length||t.results.length)+"件)",1),t.collapsed?((0,n.wg)(),(0,n.iD)("span",_," - 縮小中")):(0,n.kq)("",!0)]),(0,n._)("div",D,[(0,n._)("button",{class:"ghost",onClick:i=>Ct.toggleCollapse(t.id)},(0,o.zw)(t.collapsed?"展開":"縮小"),9,C),(0,n._)("button",{class:"ghost",onClick:i=>Ct.removeBlock(t.id)},"閉じる",8,A)])]),(0,n.wy)((0,n._)("div",S,[((0,n.wg)(!0),(0,n.iD)(n.HY,null,(0,n.Ko)(t.results,(t=>((0,n.wg)(),(0,n.iD)("div",{key:t.type+"-"+t.id,draggable:"unit"===t.type||"equip"===t.type,onDragstart:i=>Ct.onDragStartCard(i,t)},[X.compactView?((0,n.wg)(),(0,n.iD)("div",{key:1,class:(0,o.C_)(["card","compact",{"in-use-compact":Ct.isInFormation(t)}]),title:t.name},[(0,n._)("div",{class:(0,o.C_)(["thumb small",t.image]),"aria-hidden":"true"},null,2)],10,Q)):((0,n.wg)(),(0,n.iD)("div",I,[(0,n._)("div",F,[(0,n._)("div",{class:(0,o.C_)(["thumb",t.image]),"aria-hidden":"true"},null,2),(0,n._)("div",x,[(0,n._)("h4",$,(0,o.zw)(t.name),1),(0,n._)("div",L,["unit"===t.type?((0,n.wg)(),(0,n.iD)("button",{key:0,onClick:i=>Ct.toggleInFormation(t)},(0,o.zw)(Ct.isInFormation(t)?"編成から外す":"編成へ追加"),9,R)):(0,n.kq)("",!0),Ct.isInFormation(t)?((0,n.wg)(),(0,n.iD)("div",O,"使用中")):(0,n.kq)("",!0)])])]),(0,n._)("div",j,[(0,n._)("ul",z,[((0,n.wg)(!0),(0,n.iD)(n.HY,null,(0,n.Ko)(t.matches||[],(t=>((0,n.wg)(),(0,n.iD)("li",{key:t.id+"-"+t.trigger},[(0,n._)("div",B,[t.trigger1&&t.trigger2?((0,n.wg)(),(0,n.iD)(n.HY,{key:0},["and"===t.andor?((0,n.wg)(),(0,n.iD)("span",E,"発動: "+(0,o.zw)(t.trigger1)+" かつ "+(0,o.zw)(t.trigger2),1)):"or"===t.andor?((0,n.wg)(),(0,n.iD)("span",V,"発動: "+(0,o.zw)(t.trigger1)+" または "+(0,o.zw)(t.trigger2),1)):((0,n.wg)(),(0,n.iD)("span",N,"発動: "+(0,o.zw)(t.trigger1)+" / "+(0,o.zw)(t.trigger2),1))],64)):((0,n.wg)(),(0,n.iD)("span",H,"発動: "+(0,o.zw)(t.trigger1||t.trigger2||t.trigger),1))]),(0,n._)("div",Y,[(0,n._)("div",K,"対象: "+(0,o.zw)(Array.isArray(t.target)?t.target.join("、"):t.target),1),(0,n._)("div",J,[t.effect?((0,n.wg)(),(0,n.iD)("span",P,"効果量: "+(0,o.zw)(t.effect),1)):(0,n.kq)("",!0),t.duration?((0,n.wg)(),(0,n.iD)("span",U," 持続: "+(0,o.zw)(t.duration),1)):(0,n.kq)("",!0),t.cumulative?((0,n.wg)(),(0,n.iD)("span",Z," 累積: "+(0,o.zw)(t.cumulative),1)):(0,n.kq)("",!0)])])])))),128)),0===(t.matches||[]).length?((0,n.wg)(),(0,n.iD)("li",G,"該当する特性データがありません")):(0,n.kq)("",!0)])])]))],40,M)))),128))],512),[[s.F8,!t.collapsed]])])))),128)),0===X.blocks.length?((0,n.wg)(),(0,n.iD)("div",W,tt)):(0,n.kq)("",!0)])],512),(0,n._)("aside",null,[(0,n._)("div",it,[et,st,(0,n._)("div",nt,[((0,n.wg)(!0),(0,n.iD)(n.HY,null,(0,n.Ko)(X.formations,((t,e)=>((0,n.wg)(),(0,n.iD)("div",{class:"formation-box",key:e},[(0,n._)("div",ot,"編成 "+(0,o.zw)(e+1),1),(0,n._)("div",lt,[((0,n.wg)(!0),(0,n.iD)(n.HY,null,(0,n.Ko)(t,((t,i)=>((0,n.wg)(),(0,n.iD)("div",{key:e+"-"+i,class:(0,o.C_)(["slot",{"drag-over":X.dropTarget&&X.dropTarget.form===e&&X.dropTarget.index===i}]),draggable:!!t,onDragstart:s=>t&&Ct.onDragStartSlot(s,e,i),onDragenter:(0,s.iM)((t=>Ct.onDragEnterSlot(e,i)),["prevent"]),onDragover:(0,s.iM)((t=>Ct.onDragOverSlot(t,e,i)),["prevent"]),onDragleave:t=>Ct.onDragLeaveSlot(e,i),onDrop:(0,s.iM)((t=>Ct.onDropToSlot(t,e,i)),["prevent"])},[t?((0,n.wg)(),(0,n.iD)("div",rt,[(0,n._)("div",{class:(0,o.C_)(["thumb small",t.image]),"aria-hidden":"true",onDblclick:(0,s.iM)((t=>Ct.onSlotDoubleClick(e,i)),["stop","prevent"])},null,42,ct)])):((0,n.wg)(),(0,n.iD)("div",ut))],42,at)))),128))]),(0,n._)("div",dt,[(0,n._)("button",{class:"ghost",onClick:t=>Ct.clearFormation(e)},"全解除",8,ht),(0,n._)("button",{class:"ghost",onClick:t=>Ct.openSaveFormationDialog(e)},"ライブラリへ保存",8,mt)]),X.savingForFormation===e?((0,n.wg)(),(0,n.iD)("div",ft,[(0,n._)("div",pt,[gt,(0,n.wy)((0,n._)("textarea",{"onUpdate:modelValue":i[4]||(i[4]=t=>X.savingMemo=t),rows:"4",placeholder:"編成の説明を入力してください"},null,512),[[s.nr,X.savingMemo]]),(0,n._)("div",yt,[(0,n._)("button",{class:"ghost",onClick:t=>Ct.doSaveFormationToLib(e)},"保存",8,vt),(0,n._)("button",{class:"ghost",onClick:i[5]||(i[5]=(...t)=>Ct.cancelSaveFormationDialog&&Ct.cancelSaveFormationDialog(...t))},"キャンセル")])])])):(0,n.kq)("",!0),(0,n._)("div",wt,[(0,n._)("div",kt,[((0,n.wg)(!0),(0,n.iD)(n.HY,null,(0,n.Ko)(t,((t,l)=>((0,n.wg)(),(0,n.iD)(n.HY,null,[t?((0,n.wg)(),(0,n.iD)("div",{class:"equip-row-item",key:e+"-er-"+l},[(0,n._)("div",bt,[(0,n._)("div",{class:(0,o.C_)(["thumb tiny",t&&t.image||""]),"aria-hidden":"true"},null,2)]),(0,n._)("div",qt,[((0,n.wg)(!0),(0,n.iD)(n.HY,null,(0,n.Ko)(Ct.getMaxEquip(t),(t=>((0,n.wg)(),(0,n.iD)("div",{class:"equip-slot",key:t,onDragover:i[6]||(i[6]=(0,s.iM)((()=>{}),["prevent"])),onDrop:(0,s.iM)((i=>Ct.onDropToEquipSlot(i,e,l,t-1)),["prevent"])},[X.equipmentAssignments[e+"-"+l]&&X.equipmentAssignments[e+"-"+l][t-1]?((0,n.wg)(),(0,n.iD)("div",{key:0,class:(0,o.C_)(["thumb tiny",X.equipmentAssignments[e+"-"+l][t-1].equip.image||""]),draggable:"true",onDragstart:i=>Ct.onDragStartInstance(i,X.equipmentAssignments[e+"-"+l][t-1].id),onDblclick:(0,s.iM)((i=>Ct.onEquipInstanceDoubleClick(e,l,t-1)),["stop","prevent"])},null,42,_t)):((0,n.wg)(),(0,n.iD)("div",Dt,"+"))],40,Tt)))),128))])])):(0,n.kq)("",!0)],64)))),256))])])])))),128))])])])])],2)}var At=e(7349),St={name:"TraitSearch",data(){return{compactView:!1,term:"",transientMessage:"",transientTimer:null,blocks:[],nextBlockId:1,units:[],equips:[],equipmentAssignments:{},equipInstanceCounter:1,instanceAssignmentMap:{},unitTokuseiList:[],soubiTokuseiList:[],formations:[[null,null,null,null,null,null],[null,null,null,null,null,null],[null,null,null,null,null,null]],currentFormation:0,savingForFormation:null,savingMemo:"",dropTarget:null,placedMap:{}}},async mounted(){this.$nextTick((()=>{const t=this.$refs.searchInput;t&&"function"===typeof t.focus&&t.focus()}));try{const t=At.quickLoad();this.applyData(t),At.load().then((t=>{t&&this.applyData(t)})).catch((t=>{console.warn("storage.load() failed",t)}))}catch(t){console.error("データ読み込みエラー",t)}},methods:{applyData(t){if(!t)return;const{unitList:i=[],unitTokuseiList:e=[],soubiList:s=[],soubiTokuseiList:n=[]}=t;this.unitTokuseiList=e,this.soubiTokuseiList=n;const o={};for(const r of e){const t=r.unit_no;o[t]||(o[t]=[]),r["特性"]&&o[t].push(r["特性"])}const l={};for(const r of n){const t=r.soubi_no;l[t]||(l[t]=[]),r["特性"]&&l[t].push(r["特性"])}this.units=(i||[]).slice().reverse().map((t=>({id:"u"+t.no,type:"unit",no:t.no,name:t.name,rarity:t.rarity||3,attribute:t.type||"",hp:t.hp,attack:t.power,traits:o[t.no]||[],image:t.image||"",equips:[]}))),this.equips=(s||[]).slice().reverse().map((t=>({id:"e"+t.no,type:"equip",no:t.no,name:t.name,rarity:t.rarity||3,hp:t.hp,power:t.power,traits:l[t.no]||[],image:t.image||""})));try{this.reevaluateSavedSearches()}catch(a){}},computeResultsForTrait(t){const i=(t||"").trim().toLowerCase();if(!i)return[];const e=[];for(const s of this.units){const t=(this.unitTokuseiList||[]).filter((t=>t.unit_no===s.no&&t["特性"]&&t["特性"].trim().toLowerCase()===i));t.length&&e.push(Object.assign({},s,{matches:t.map((t=>({id:t.id||`${s.no}-u-${Math.random()}`,trigger1:t.trigger1||"",trigger2:t.trigger2||"",andor:String(t.andor||"").toLowerCase(),trigger:[t.trigger1,t.trigger2].filter(Boolean).join(" / "),target:Array.isArray(t["対象"])?t["対象"]:t["対象"]||"",effect:t["効果量"]||"",duration:t["持続"]||"",cumulative:t["累積"]||""})))}))}for(const s of this.equips){const t=(this.soubiTokuseiList||[]).filter((t=>t.soubi_no===s.no&&t["特性"]&&t["特性"].trim().toLowerCase()===i));t.length&&e.push(Object.assign({},s,{matches:t.map((t=>({id:t.id||`${s.no}-s-${Math.random()}`,trigger1:t.trigger1||"",trigger2:t.trigger2||"",andor:String(t.andor||"").toLowerCase(),trigger:[t.trigger1,t.trigger2].filter(Boolean).join(" / "),target:Array.isArray(t["対象"])?t["対象"]:t["対象"]||"",effect:t["効果量"]||"",duration:t["持続"]||"",cumulative:t["累積"]||""})))}))}return e},computeCountForTrait(t){const i=(t||"").trim().toLowerCase();if(!i)return 0;const e=new Set,s=new Set;for(const n of this.unitTokuseiList||[])n["特性"]&&String(n["特性"]).trim().toLowerCase()===i&&e.add(n.unit_no);for(const n of this.soubiTokuseiList||[])n["特性"]&&String(n["特性"]).trim().toLowerCase()===i&&s.add(n.soubi_no);return e.size+s.size},reevaluateSavedSearches(){let t=null;try{t=At.traitSearchData("state.v1")}catch(i){t=null}if(t){if("boolean"===typeof t.compactView&&(this.compactView=t.compactView),Array.isArray(t.formations)){this.formations=this.formations.map((t=>t.map((()=>null))));for(let i=0;i<t.formations.length&&i<this.formations.length;i++){const e=t.formations[i];if(Array.isArray(e))for(let t=0;t<e.length&&t<this.formations[i].length;t++){const s=e[t];if(!s){this.formations[i][t]=null;continue}const n=(this.units||[]).find((t=>t.id===s))||null;n&&(this.formations[i][t]=n,this.placedMap[n.id]={f:i,i:t})}}}if(t.equipment&&"object"===typeof t.equipment){this.equipmentAssignments={},this.instanceAssignmentMap={};for(const i of Object.keys(t.equipment)){const e=Array.isArray(t.equipment[i])?t.equipment[i]:[];if(e&&e.length){this.equipmentAssignments[i]=[];for(const t of e){const e=(this.equips||[]).find((i=>i.id===t))||null;if(!e)continue;const s=this.makeEquipInstance(e);this.equipmentAssignments[i].push(s),this.instanceAssignmentMap[s.id]=i}}}}if(Array.isArray(t.traits)&&t.traits.length){this.blocks=[];for(const i of t.traits){const t=this.computeCountForTrait(i);if(!t||0===t)continue;const e={id:this.nextBlockId++,trait:i,fullResults:null,results:[],count:t,collapsed:!0,_fillTimer:null,_chunkIdx:0};this.blocks.push(e)}}}},saveState(){const t={compactView:!!this.compactView,traits:(this.blocks||[]).map((t=>t.trait)),formations:(this.formations||[]).map((t=>t.map((t=>t&&t.id?t.id:null)))),equipment:{}};for(const e of Object.keys(this.equipmentAssignments||{})){const i=this.equipmentAssignments[e]||[];t.equipment[e]=i.map((t=>t&&t.equip&&t.equip.id?t.equip.id:null)).filter(Boolean)}try{At.traitSearchData("state.v1",t)}catch(i){}},scheduleFillForBlock(t){if(!t)return;const i=60,e=80;t.results||(t.results=[]);try{if(t._fillTimer)return}catch(n){}const s=()=>{try{if(!t.fullResults){try{t.fullResults=this.computeResultsForTrait(t.trait)}catch(n){t.fullResults=[]}try{t.count=t.fullResults.length}catch(n){}if(!t.fullResults||0===t.fullResults.length){const i=this.blocks.findIndex((i=>i.id===t.id));-1!==i&&this.blocks.splice(i,1);try{this.saveState()}catch(n){}return void(t._fillTimer=null)}t.results=t.fullResults.slice(0,Math.min(e,t.fullResults.length))}const o=t.fullResults.length,l=t.results.length;if(l>=o)return void(t._fillTimer=null);const a=l,r=Math.min(o,a+i);t.results.push(...t.fullResults.slice(a,r)),r<o?"undefined"!==typeof window&&"function"===typeof window.requestIdleCallback?t._fillTimer=window.requestIdleCallback((()=>s()),{timeout:200}):t._fillTimer=setTimeout((()=>s()),40):t._fillTimer=null}catch(n){t._fillTimer=null}};"undefined"!==typeof window&&"function"===typeof window.requestIdleCallback?t._fillTimer=window.requestIdleCallback((()=>s()),{timeout:200}):t._fillTimer=setTimeout((()=>s()),40)},searchTrait(){const t=(this.term||"").trim();if(!t)return alert("特性名を入力してください"),void this.$nextTick((()=>{const t=this.$refs.searchInput;t&&"function"===typeof t.focus&&t.focus()}));const i=t.toLowerCase(),e=(this.blocks||[]).findIndex((t=>(t.trait||"").trim().toLowerCase()===i));if(-1!==e){const t=this.blocks[e];t.collapsed=!1,this.blocks.splice(e,1),this.blocks.unshift(t);const i=80,s=60;t.fullResults&&t.results&&t.results.length<Math.min(i,t.fullResults.length)&&(t.results=t.fullResults.slice(0,Math.min(i,t.fullResults.length)));try{t.fullResults&&(t.count=t.fullResults.length)}catch(c){}const n=()=>{if(!t.fullResults)return;const i=t.fullResults.length,e=t.results.length;if(e>=i)return;const o=e,l=Math.min(i,o+s);t.results.push(...t.fullResults.slice(o,l)),l<i&&("undefined"!==typeof window&&"function"===typeof window.requestIdleCallback?t._fillTimer=window.requestIdleCallback((()=>n()),{timeout:200}):t._fillTimer=setTimeout((()=>n()),40))};t.fullResults&&t.results.length<t.fullResults.length&&("undefined"!==typeof window&&"function"===typeof window.requestIdleCallback?t._fillTimer=window.requestIdleCallback((()=>n()),{timeout:200}):t._fillTimer=setTimeout((()=>n()),40));try{t.fullResults||this.scheduleFillForBlock(t)}catch(c){}this.$nextTick((()=>{const t=this.$refs.mainColumn;t&&"undefined"!==typeof t.scrollTop&&(t.scrollTop=0);const i=this.$refs.searchInput;i&&"function"===typeof i.focus&&i.focus()}));try{this.saveState()}catch(c){}return void(this.term="")}const s=[];for(const u of this.units){const t=(this.unitTokuseiList||[]).filter((t=>t.unit_no===u.no&&t["特性"]&&t["特性"].trim().toLowerCase()===i));if(t.length){const i=t.map((t=>({id:t.id||`${u.no}-u-${Math.random()}`,trigger1:t.trigger1||"",trigger2:t.trigger2||"",andor:String(t.andor||"").toLowerCase(),trigger:[t.trigger1,t.trigger2].filter(Boolean).join(" / "),target:Array.isArray(t["対象"])?t["対象"]:t["対象"]||"",effect:t["効果量"]||"",duration:t["持続"]||"",cumulative:t["累積"]||""})));s.push(Object.assign({},u,{matches:i}))}}for(const u of this.equips){const t=(this.soubiTokuseiList||[]).filter((t=>t.soubi_no===u.no&&t["特性"]&&t["特性"].trim().toLowerCase()===i));if(t.length){const i=t.map((t=>({id:t.id||`${u.no}-s-${Math.random()}`,trigger1:t.trigger1||"",trigger2:t.trigger2||"",andor:String(t.andor||"").toLowerCase(),trigger:[t.trigger1,t.trigger2].filter(Boolean).join(" / "),target:Array.isArray(t["対象"])?t["対象"]:t["対象"]||"",effect:t["効果量"]||"",duration:t["持続"]||"",cumulative:t["累積"]||""})));s.push(Object.assign({},u,{matches:i}))}}if(!s||0===s.length)return this.term="",this.showTransient("該当する特性はありません"),void this.$nextTick((()=>{const t=this.$refs.searchInput;t&&"function"===typeof t.focus&&t.focus()}));const n=80,o=60,l=s,a={id:this.nextBlockId++,trait:t,fullResults:l,results:l.slice(0,n),count:l.length,collapsed:!1,_fillTimer:null,_chunkIdx:1};this.blocks.unshift(a);try{this.saveState()}catch(c){}const r=()=>{if(!a.fullResults)return;const t=a.fullResults.length,i=a.results.length;if(i>=t)return;const e=i,s=Math.min(t,e+o);a.results.push(...a.fullResults.slice(e,s)),s<t&&("undefined"!==typeof window&&"function"===typeof window.requestIdleCallback?a._fillTimer=window.requestIdleCallback((()=>r()),{timeout:200}):a._fillTimer=setTimeout((()=>r()),40))};l.length>a.results.length&&("undefined"!==typeof window&&"function"===typeof window.requestIdleCallback?a._fillTimer=window.requestIdleCallback((()=>r()),{timeout:200}):a._fillTimer=setTimeout((()=>r()),40)),this.term="",this.$nextTick((()=>{const t=this.$refs.mainColumn;t&&"undefined"!==typeof t.scrollTop&&(t.scrollTop=0);const i=this.$refs.searchInput;i&&"function"===typeof i.focus&&i.focus()}))},removeBlock(t){const i=this.blocks.findIndex((i=>i.id===t));if(-1===i)return;const e=this.blocks[i];try{e&&e._fillTimer&&("undefined"!==typeof window&&"function"===typeof window.cancelIdleCallback?window.cancelIdleCallback(e._fillTimer):clearTimeout(e._fillTimer))}catch(s){}this.blocks.splice(i,1);try{this.saveState()}catch(s){}},toggleCollapse(t){const i=this.blocks.findIndex((i=>i.id===t));if(-1===i)return;const e=this.blocks[i];if(e.collapsed=!e.collapsed,this.blocks.splice(i,1),this.blocks.unshift(e),!e.collapsed){this.$nextTick((()=>{const t=this.$refs.mainColumn;t&&"undefined"!==typeof t.scrollTop&&(t.scrollTop=0)}));try{this.scheduleFillForBlock(e)}catch(s){}}},expandBlockById(t){const i=this.blocks.findIndex((i=>i.id===t));if(-1===i)return;const e=this.blocks[i];e.collapsed&&(e.collapsed=!1,this.blocks.splice(i,1),this.blocks.unshift(e),this.$nextTick((()=>{const t=this.$refs.mainColumn;t&&"undefined"!==typeof t.scrollTop&&(t.scrollTop=0);try{this.scheduleFillForBlock(e)}catch(i){}})))},collapseAllVisible(){for(const t of this.blocks)t.collapsed=!0;this.$nextTick((()=>{const t=this.$refs.mainColumn;t&&"undefined"!==typeof t.scrollTop&&(t.scrollTop=0)}))},onDragStartCard(t,i){!i||"unit"!==i.type&&"equip"!==i.type||t.dataTransfer.setData("text/plain",JSON.stringify({source:"search",id:i.id,type:i.type}))},onDragStartInstance(t,i){if(!i)return;let e=null;try{const t=this.instanceAssignmentMap[i];if(t&&this.equipmentAssignments[t]){const s=this.equipmentAssignments[t].find((t=>t&&t.id===i));s&&s.equip&&s.equip.id&&(e=s.equip.id)}}catch(t){}t.dataTransfer.setData("text/plain",JSON.stringify({source:"instance",id:i,type:"equip",equipId:e}))},onDragStartSlot(t,i,e){const s=this.formations[i],n=s[e];n&&t.dataTransfer.setData("text/plain",JSON.stringify({source:"formation",id:n.id,fromFormation:i,fromIndex:e}))},onDragEnterSlot(t,i){this.dropTarget={form:t,index:i}},onDragOverSlot(t,i,e){t.preventDefault(),this.dropTarget={form:i,index:e}},onDragLeaveSlot(t,i){this.dropTarget&&this.dropTarget.form===t&&this.dropTarget.index===i&&(this.dropTarget=null)},onDropToSlot(t,i,e){this.dropTarget=null;let s=null;try{s=JSON.parse(t.dataTransfer.getData("text/plain"))}catch(n){return}if(s){if("formation"===s.source){const n=Number(s.fromFormation),o=Number(s.fromIndex);if(isNaN(o)||isNaN(n))return;const l=this.formations[n],a=this.formations[i],r=l[o],c=a[e];a[e]=r,l[o]=c;try{const t=`${n}-${o}`,s=`${i}-${e}`,l=this.equipmentAssignments[t];this.equipmentAssignments[t]=this.equipmentAssignments[s],this.equipmentAssignments[s]=l;const a=this.equipmentAssignments[t]||[],r=this.equipmentAssignments[s]||[];for(const i of a)i&&i.id&&(this.instanceAssignmentMap[i.id]=t);for(const i of r)i&&i.id&&(this.instanceAssignmentMap[i.id]=s)}catch(t){}try{this.saveState()}catch(t){}return a[e]&&(this.placedMap[a[e].id]={f:i,i:e}),l[o]&&(this.placedMap[l[o].id]={f:n,i:o}),c&&delete this.placedMap[c.id],void(!r||a[e]&&a[e].id===r.id||(this.placedMap[r.id]={f:i,i:e}))}if("search"===s.source){const n=this.formations[i];if(n[e])return void this.showTransient("スロットが埋まっています。入れ替えは編成内のユニットをドラッグしてください",3e3);const o=s.id,l=(this.units||[]).find((t=>t.id===o));if(!l)return void this.showTransient("ユニットが見つかりません",2e3);const a=this.placedMap[l.id];a&&"number"===typeof a.f&&"number"===typeof a.i&&(this.formations[a.f][a.i]=null,delete this.placedMap[l.id]);const r=n[e];r&&delete this.placedMap[r.id],n[e]=l,this.placedMap[l.id]={f:i,i:e};try{this.saveState()}catch(t){}if("equip"===s.type){const n=s.id,o=(this.equips||[]).find((t=>t.id===n));if(!o)return void this.showTransient("装備が見つかりません",2e3);const l=`${i}-${e}`;this.equipmentAssignments[l]||(this.equipmentAssignments[l]=[]);const a=this.formations[i][e],r=this.getMaxEquip(a);if(this.equipmentAssignments[l].length>=r)return void this.showTransient("装備上限に達しています",2e3);const c=this.makeEquipInstance(o);this.equipmentAssignments[l].push(c),this.instanceAssignmentMap[c.id]=l;try{this.saveState()}catch(t){}}}}},showTransient(t,i=3e3){this.transientTimer&&clearTimeout(this.transientTimer),this.transientMessage=t,this.transientTimer=setTimeout((()=>{this.transientMessage="",this.transientTimer=null}),i)},makeEquipInstance(t){const i="inst"+this.equipInstanceCounter++;return{id:i,equip:t}},onDropToEquipSlot(t,i,e,s){let n=null;try{n=JSON.parse(t.dataTransfer.getData("text/plain"))}catch(l){return}if(!n)return;const o=`${i}-${e}`;if(this.equipmentAssignments[o]||(this.equipmentAssignments[o]=[]),"instance"!==n.source||"equip"!==n.type){if("search"===n.source&&"equip"===n.type){const s=(this.equips||[]).find((t=>t.id===n.id));if(!s)return void this.showTransient("装備が見つかりません",2e3);const l=this.formations[i][e],a=this.getMaxEquip(l);if(this.equipmentAssignments[o].length>=a)return void this.showTransient("装備上限に達しています",2e3);const r=this.makeEquipInstance(s);this.equipmentAssignments[o].push(r),this.instanceAssignmentMap[r.id]=o;try{this.saveState()}catch(t){}}}else{const i=n.id,e=this.instanceAssignmentMap[i];if(e&&this.equipmentAssignments[e]){const t=this.equipmentAssignments[e],s=t.findIndex((t=>t&&t.id===i));-1!==s&&t.splice(s,1)}const s=(this.equips||[]).find((t=>t.id===n.equipId))||null;this.equipmentAssignments[o].push({id:i,equip:s}),this.instanceAssignmentMap[i]=o;try{this.saveState()}catch(t){}}},toggleInFormation(t){if("unit"!==t.type)return void alert("ユニットのみ編成できます");const i=this.placedMap[t.id];if(i&&"number"===typeof i.f&&"number"===typeof i.i){this.formations[i.f][i.i]=null,delete this.placedMap[t.id];try{this.saveState()}catch(e){}}else{for(let i=0;i<this.formations.length;i++){const s=this.formations[i].findIndex((t=>!t));if(-1!==s){this.formations[i][s]=t,this.placedMap[t.id]={f:i,i:s};try{this.saveState()}catch(e){}return}}alert("空きスロットがありません")}},getMaxEquip(t){return t&&t.traits&&Array.isArray(t.traits)&&t.traits.includes("鏡スロット追加")?4:2},assignedCountFor(t,i){const e=`${t}-${i}`;return(this.equipmentAssignments[e]||[]).length},isInFormation(t){return!!(t&&t.id&&this.placedMap[t.id])},removeFromFormation(t,i){const e=this.formations[t][i];e&&e.id&&delete this.placedMap[e.id],this.formations[t][i]=null;try{this.saveState()}catch(s){}},onSlotDoubleClick(t,i){this.removeFromFormation(t,i)},onEquipInstanceDoubleClick(t,i,e){const s=`${t}-${i}`,n=this.equipmentAssignments[s]||[];if(e<0||e>=n.length)return;const o=n[e];if(o){n.splice(e,1);try{o.id&&delete this.instanceAssignmentMap[o.id]}catch(l){}0===n.length&&delete this.equipmentAssignments[s];try{this.saveState()}catch(l){}}},openSaveFormationDialog(t){this.savingForFormation=t;try{this.savingMemo=this.generateFormationMemo(t)}catch(i){this.savingMemo=""}this.$nextTick((()=>{const t=document.querySelector(".save-dialog textarea");t&&"function"===typeof t.focus&&t.focus()}))},cancelSaveFormationDialog(){this.savingForFormation=null,this.savingMemo=""},doSaveFormationToLib(t){try{const i=At.libData()||[],e={};for(let s=0;s<(this.formations[t]||[]).length;s++){const i=this.formations[t][s],n=(s+1).toString(),o={};o.unit_no=i&&i.no?i.no:null;const l=`${t}-${s}`,a=this.equipmentAssignments[l]||[],r=this.getMaxEquip(i)||2;for(let t=0;t<r&&t<4;t++){const i=`soubi${t+1}_no`;o[i]=a[t]&&a[t].equip&&"undefined"!==typeof a[t].equip.no?a[t].equip.no:null}"undefined"===typeof o.soubi1_no&&(o.soubi1_no=null),"undefined"===typeof o.soubi2_no&&(o.soubi2_no=null),e[n]=o}e.memo=this.savingMemo||"",i.push(e),At.libData(i),this.showTransient("編成をライブラリに保存しました",2500)}catch(i){console.error("doSaveFormationToLib failed",i),this.showTransient("保存に失敗しました",3e3)}finally{this.savingForFormation=null,this.savingMemo=""}},generateFormationMemo(t){const i=[],e=this.formations[t]||[];for(let s=0;s<e.length;s++){const n=s+1,o=e[s],l=o&&o.name?o.name:"（空）",a=`${t}-${s}`,r=this.equipmentAssignments[a]||[],c=this.getMaxEquip(o)||2,u=[];for(let t=0;t<c&&t<4;t++)u.push(r[t]&&r[t].equip&&r[t].equip.name?r[t].equip.name:"（空）");i.push(`${n}: ${l} — 装備: ${u.join(", ")}`)}return i.join("\n")},clearBlocks(){for(const i of this.blocks)try{i&&i._fillTimer&&("undefined"!==typeof window&&"function"===typeof window.cancelIdleCallback?window.cancelIdleCallback(i._fillTimer):clearTimeout(i._fillTimer))}catch(t){}try{this.saveState()}catch(t){}this.blocks=[]},clearFormation(t){for(let e=0;e<this.formations[t].length;e++){const s=this.formations[t][e];s&&s.id&&delete this.placedMap[s.id],this.formations[t][e]=null;const n=`${t}-${e}`,o=this.equipmentAssignments[n];if(o&&Array.isArray(o))for(const t of o)try{t&&t.id&&delete this.instanceAssignmentMap[t.id]}catch(i){}try{delete this.equipmentAssignments[n]}catch(i){}}try{this.saveState()}catch(i){}}},watch:{compactView(t){try{this.saveState()}catch(i){}}}},Mt=e(3744);const It=(0,Mt.Z)(St,[["render",Ct],["__scopeId","data-v-617ff240"]]);var Ft=It;(0,s.ri)(Ft).mount("#main")}},i={};function e(s){var n=i[s];if(void 0!==n)return n.exports;var o=i[s]={exports:{}};return t[s].call(o.exports,o,o.exports,e),o.exports}e.m=t,function(){var t=[];e.O=function(i,s,n,o){if(!s){var l=1/0;for(u=0;u<t.length;u++){s=t[u][0],n=t[u][1],o=t[u][2];for(var a=!0,r=0;r<s.length;r++)(!1&o||l>=o)&&Object.keys(e.O).every((function(t){return e.O[t](s[r])}))?s.splice(r--,1):(a=!1,o<l&&(l=o));if(a){t.splice(u--,1);var c=n();void 0!==c&&(i=c)}}return i}o=o||0;for(var u=t.length;u>0&&t[u-1][2]>o;u--)t[u]=t[u-1];t[u]=[s,n,o]}}(),function(){e.d=function(t,i){for(var s in i)e.o(i,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:i[s]})}}(),function(){e.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"===typeof window)return window}}()}(),function(){e.o=function(t,i){return Object.prototype.hasOwnProperty.call(t,i)}}(),function(){e.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}}(),function(){e.j=777}(),function(){var t={777:0};e.O.j=function(i){return 0===t[i]};var i=function(i,s){var n,o,l=s[0],a=s[1],r=s[2],c=0;if(l.some((function(i){return 0!==t[i]}))){for(n in a)e.o(a,n)&&(e.m[n]=a[n]);if(r)var u=r(e)}for(i&&i(s);c<l.length;c++)o=l[c],e.o(t,o)&&t[o]&&t[o][0](),t[o]=0;return e.O(u)},s=self["webpackChunkfront"]=self["webpackChunkfront"]||[];s.forEach(i.bind(null,0)),s.push=i.bind(null,s.push.bind(s))}();var s=e.O(void 0,[998,64],(function(){return e(4168)}));s=e.O(s)})();